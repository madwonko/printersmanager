{% extends "base.html" %}

{% block title %}{{ printer.name }} - Printer Monitoring{% endblock %}

{% block extra_css %}
<style>
    .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .detail-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .detail-card h3 {
        margin-bottom: 1rem;
        color: #2c3e50;
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #ecf0f1;
    }
    
    .info-row:last-child {
        border-bottom: none;
    }
    
    .info-label {
        color: #7f8c8d;
        font-weight: 500;
    }
    
    .info-value {
        color: #2c3e50;
        font-weight: 600;
    }
    
    .chart-container {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    
    input[type="text"] {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 1.5rem;">
    <a href="/" style="color: #3498db; text-decoration: none;">‚Üê Back to Dashboard</a>
</div>

<h1 style="margin-bottom: 1.5rem;">{{ printer.name }}</h1>

<div class="detail-grid">
    <div class="detail-card">
        <h3>Printer Information</h3>
        <div class="info-row">
            <span class="info-label">IP Address:</span>
            <span class="info-value">{{ printer.ip }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Model:</span>
            <span class="info-value">{{ printer.model or 'Unknown' }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Location:</span>
            <span class="info-value" id="location-display">{{ printer.location }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">First Seen:</span>
            <span class="info-value">{{ printer.first_seen.split('.')[0] }}</span>
        </div>
        
        <div style="margin-top: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; color: #7f8c8d;">Update Location:</label>
            <input type="text" id="location-input" value="{{ printer.location }}" placeholder="Enter location">
            <button class="btn" onclick="updateLocation()" style="margin-top: 0.5rem; width: 100%;">Save Location</button>
        </div>
    </div>
    
    <div class="detail-card">
        <h3>Current Status</h3>
        {% if latest_metrics %}
        <div class="info-row">
            <span class="info-label">Total Pages:</span>
            <span class="info-value">{{ "{:,}".format(latest_metrics.total_pages) if latest_metrics.total_pages else 'N/A' }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Toner Level:</span>
            {% if latest_metrics.toner_level_pct is not none %}
                <span class="info-value {% if latest_metrics.toner_level_pct < 20 %}status-critical{% elif latest_metrics.toner_level_pct < 50 %}status-warning{% else %}status-ok{% endif %}">
                    {{ latest_metrics.toner_level_pct }}%
                </span>
            {% elif latest_metrics.toner_status %}
                <span class="info-value status-ok">{{ latest_metrics.toner_status }}</span>
            {% else %}
                <span class="info-value">N/A</span>
            {% endif %}
        </div>
        {% if latest_metrics.drum_level_pct is not none %}
        <div class="info-row">
            <span class="info-label">Drum Unit:</span>
            <span class="info-value {% if latest_metrics.drum_level_pct < 20 %}status-critical{% elif latest_metrics.drum_level_pct < 50 %}status-warning{% else %}status-ok{% endif %}">
                {{ latest_metrics.drum_level_pct }}%
            </span>
        </div>
        {% endif %}
        <div class="info-row">
            <span class="info-label">Last Updated:</span>
            <span class="info-value">{{ latest_metrics.timestamp.split('.')[0] }}</span>
        </div>
        {% else %}
        <p style="color: #7f8c8d;">No metrics data available</p>
        {% endif %}
    </div>
</div>

<div class="detail-grid">
    <div class="detail-card">
        <h3>Usage (Last 7 Days)</h3>
        {% if usage_7 and usage_7.pages_printed %}
        <div class="info-row">
            <span class="info-label">Pages Printed:</span>
            <span class="info-value">{{ "{:,}".format(usage_7.pages_printed) }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Readings:</span>
            <span class="info-value">{{ usage_7.readings }}</span>
        </div>
        {% else %}
        <p style="color: #7f8c8d;">No usage data for this period</p>
        {% endif %}
    </div>
    
    <div class="detail-card">
        <h3>Usage (Last 30 Days)</h3>
        {% if usage_30 and usage_30.pages_printed %}
        <div class="info-row">
            <span class="info-label">Pages Printed:</span>
            <span class="info-value">{{ "{:,}".format(usage_30.pages_printed) }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Readings:</span>
            <span class="info-value">{{ usage_30.readings }}</span>
        </div>
        {% else %}
        <p style="color: #7f8c8d;">No usage data for this period</p>
        {% endif %}
    </div>
</div>

<div class="chart-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>Page Count History</h3>
        <select id="period-selector" onchange="changePeriod()" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            <option value="7" {% if current_period == 7 %}selected{% endif %}>Last 7 Days</option>
            <option value="14" {% if current_period == 14 %}selected{% endif %}>Last 14 Days</option>
            <option value="30" {% if current_period == 30 %}selected{% endif %}>Last 30 Days</option>
            <option value="60" {% if current_period == 60 %}selected{% endif %}>Last 60 Days</option>
            <option value="90" {% if current_period == 90 %}selected{% endif %}>Last 90 Days</option>
        </select>
    </div>
    <canvas id="pageChart" width="400" height="200"></canvas>
</div>

<div class="chart-container">
    <h3 style="margin-bottom: 1rem;">Supply Levels</h3>
    <canvas id="supplyChart" width="400" height="200"></canvas>
</div>

<div style="margin-top: 2rem;">
    <button class="btn btn-danger" onclick="deletePrinter()">Delete Printer</button>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
const printerId = {{ printer.id }};
let pageChart, supplyChart;

function changePeriod() {
    const period = document.getElementById('period-selector').value;
    const url = new URL(window.location);
    url.searchParams.set('period', period);
    window.location.href = url.toString();
}

// Fetch chart data
function loadCharts() {
    const period = document.getElementById('period-selector').value;
    
    fetch(`/api/printer/${printerId}/chart-data?period=${period}`)
        .then(response => response.json())
        .then(data => {
            // Destroy existing charts if they exist
            if (pageChart) pageChart.destroy();
            if (supplyChart) supplyChart.destroy();
            
            // Page count chart
            pageChart = new Chart(document.getElementById('pageChart'), {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Total Pages',
                        data: data.pages,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
            
            // Supply levels chart
            const datasets = [];
            
            if (data.toner.some(v => v !== null)) {
                datasets.push({
                    label: 'Toner Level (%)',
                    data: data.toner,
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                    tension: 0.1
                });
            }
            
            if (data.drum.some(v => v !== null)) {
                datasets.push({
                    label: 'Drum Level (%)',
                    data: data.drum,
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.1
                });
            }
            
            if (datasets.length > 0) {
                supplyChart = new Chart(document.getElementById('supplyChart'), {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }
        });
}

// Load charts on page load
loadCharts();

function updateLocation() {
    const location = document.getElementById('location-input').value;
    
    fetch(`/api/printer/${printerId}/update-location`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ location: location })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('location-display').textContent = location;
            alert('Location updated successfully!');
        }
    });
}

function deletePrinter() {
    if (confirm('Are you sure you want to delete this printer and all its metrics?')) {
        fetch(`/api/printer/${printerId}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location = '/';
            }
        });
    }
}
</script>
{% endblock %}